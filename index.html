<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aè‚¡å…¬å‘Šé›·è¾¾</title>
  <style>
    :root{--bg:#f5f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--pri:#2563eb;--ok:#059669;--err:#dc2626;--bd:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#eef2ff 0,#f8fafc 40%,#f5f7fb 100%);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif;color:var(--text)}
    .wrap{max-width:1200px;margin:20px auto;padding:0 14px}
    .hero{background:rgba(255,255,255,.8);backdrop-filter: blur(8px);border:1px solid var(--bd);border-radius:16px;padding:18px 18px 12px;box-shadow:0 8px 24px rgba(15,23,42,.05)}
    h1{margin:0 0 10px;font-size:22px}.sub{color:var(--muted);font-size:13px}
    .toolbar{display:grid;grid-template-columns:1fr 1fr auto auto;gap:10px;margin-top:14px}
    input,button{height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--bd);font-size:14px}
    input:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 3px #dbeafe}
    button{background:var(--pri);color:#fff;border:none;cursor:pointer;font-weight:600}
    button:hover{opacity:.95}
    .stats{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px;margin:14px 0}
    .kpi{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:10px}
    .kpi .k{font-size:12px;color:var(--muted)} .kpi .v{font-size:22px;font-weight:700;margin-top:4px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 4px 16px rgba(15,23,42,.03)}
    h3{margin:0 0 10px;font-size:16px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#eff6ff;color:#1d4ed8;margin:0 6px 6px 0;font-size:12px}
    .status{font-size:13px;color:var(--muted)} .status.err{color:var(--err)} .status.ok{color:var(--ok)}
    table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #f1f5f9;padding:8px;text-align:left;vertical-align:top;font-size:13px}
    th{color:#475569;font-weight:600;background:#fafafa}
    .empty{color:var(--muted);font-size:13px}
    @media (max-width: 980px){.toolbar{grid-template-columns:1fr 1fr}.stats{grid-template-columns:1fr 1fr}}
    @media (max-width: 640px){.toolbar{grid-template-columns:1fr}.stats{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <h1>ğŸ“¡ Aè‚¡å…¬å‘Šé›·è¾¾ï¼ˆæŒ‰æ—¥æœŸï¼‰</h1>
    <div class="sub">æ•´åˆï¼šå…¬å‘Šåˆ†ç±» + æœºæ„è°ƒç ” + äº’åŠ¨é—®ç­”</div>
    <div class="toolbar">
      <input id="dateInput" type="date" />
      <input id="keywordInput" type="text" placeholder="ç­›é€‰ä»£ç /åç§°ï¼Œå¦‚ 600519 / èŒ…å°" />
      <button id="loadBtn">åŠ è½½æ—¥æœŸ</button>
      <input id="fileInput" type="file" accept="application/json" />
    </div>
    <div id="status" class="status" style="margin-top:10px">æ­£åœ¨åˆå§‹åŒ–â€¦</div>
  </div>

  <div class="stats">
    <div class="kpi"><div class="k">å…¬å‘Šæ€»æ•°</div><div class="v" id="kAnn">-</div></div>
    <div class="kpi"><div class="k">æœºæ„è°ƒç ”</div><div class="v" id="kRel">-</div></div>
    <div class="kpi"><div class="k">äº’åŠ¨é—®ç­”</div><div class="v" id="kP5w">-</div></div>
    <div class="kpi"><div class="k">ä¸šç»©é¢„å‘Š</div><div class="v" id="kFc">-</div></div>
    <div class="kpi"><div class="k">å½“å‰æ—¥æœŸ</div><div class="v" id="kDate" style="font-size:18px">-</div></div>
  </div>

  <div class="card">
    <h3>ğŸ§­ A. å…¬å‘Šåˆ†ç±»ç»Ÿè®¡ + æ˜ç»†</h3>
    <div id="annStats"></div>
    <div id="annList"></div>
  </div>
  <div class="card">
    <h3>ğŸ¢ B. æœºæ„è°ƒç ”æ˜ç»†ï¼ˆcninfo relationï¼‰</h3>
    <div id="relList"></div>
  </div>
  <div class="card">
    <h3>ğŸ’¬ C. äº’åŠ¨é—®ç­”æ˜ç»†ï¼ˆp5wï¼‰</h3>
    <div id="p5wList"></div>
  </div>
  <div class="card">
    <h3>ğŸ“ˆ D. ä¸šç»©é¢„å‘Šï¼ˆTushareï¼‰</h3>
    <div id="fcList"></div>
  </div>
</div>

<script>
let currentData=null;
let availableDates=[];
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const $=id=>document.getElementById(id);
const matchKey=(item,kw)=>!kw||[item.secCode,item.secName,item.companyCode,item.companyShortname].join(' ').toLowerCase().includes(kw.toLowerCase());
function setStatus(msg,type=''){const el=$('status');el.className='status '+type;el.textContent=msg;}
function setKpi(id,v){$(id).textContent=v??'-'}

function render(){
  if(!currentData) return;
  const kw=$('keywordInput').value.trim();
  const ann=currentData.announcement||{}, rel=currentData.institutionalResearch||{}, p5w=currentData.interactions||{}, fc=currentData.earningsForecast||{};
  setKpi('kDate', currentData.date||$('dateInput').value||'-');
  setKpi('kAnn', ann.ok ? (ann.items||[]).filter(x=>x.primaryLabel!=='å…¶ä»–').length : 0);
  setKpi('kRel', rel.ok ? (rel.items||[]).length : 0);
  setKpi('kP5w', p5w.ok ? (p5w.items||[]).length : 0);
  setKpi('kFc', fc.ok ? (fc.items||[]).length : 0);

  if(!ann.ok){$('annStats').innerHTML=`<div class='status err'>æš‚æ— æ•°æ®/æŠ“å–å¤±è´¥ï¼š${esc(ann.error||'æœªçŸ¥')}</div>`;$('annList').innerHTML='';}
  else {
    const statsRaw=ann.stats||{};
    const stats=Object.fromEntries(Object.entries(statsRaw).filter(([k])=>k!=='å…¶ä»–'));
    $('annStats').innerHTML=Object.keys(stats).length?Object.entries(stats).map(([k,v])=>`<span class='tag'>${esc(k)}ï¼š${v}</span>`).join(''):'<div class="empty">æš‚æ— ç»Ÿè®¡</div>';
    const items=(ann.items||[]).filter(x=>x.primaryLabel!=='å…¶ä»–').filter(x=>matchKey(x,kw));
    if(!items.length){
      $('annList').innerHTML='<div class="empty">æš‚æ— æ•°æ®</div>';
    }else{
      const byLabel = {};
      for(const it of items){
        const lb = it.primaryLabel || 'æœªåˆ†ç±»';
        if(!byLabel[lb]) byLabel[lb]=[];
        byLabel[lb].push(it);
      }
      const labelOrder = Object.keys(byLabel).sort((a,b)=> (stats[b]||0)-(stats[a]||0));
      let html = '';
      for(const lb of labelOrder){
        const arr = byLabel[lb];
        const byCompany = {};
        for(const it of arr){
          const ck = `${it.secCode||''}|${it.secName||''}`;
          if(!byCompany[ck]) byCompany[ck] = {secCode:it.secCode||'', secName:it.secName||'', items:[]};
          byCompany[ck].items.push(it);
        }
        const companies = Object.values(byCompany).sort((a,b)=>b.items.length-a.items.length);
        html += `<div style='margin:12px 0 8px;font-weight:700'>ğŸ“‚ ${esc(lb)}ï¼ˆ${arr.length}ï¼‰</div>`;
        html += companies.map(c=>{
          const rows = c.items.map(x=>`<li><a href='${esc(x.adjunctUrl||'#')}' target='_blank' rel='noopener noreferrer'>${esc(x.announcementTitle||'')}</a> <span class='muted'>(${esc(x.announcementTime||'')})</span></li>`).join('');
          return `<div style='padding:8px 10px;border:1px solid #eef2f7;border-radius:10px;margin-bottom:8px'>
            <div style='font-weight:600;margin-bottom:6px'>${esc(c.secCode)} ${esc(c.secName)} <span class='tag'>${c.items.length}æ¡</span></div>
            <ul style='margin:0;padding-left:18px'>${rows}</ul>
          </div>`;
        }).join('');
      }
      $('annList').innerHTML = html;
    }
  }

  if(!rel.ok){$('relList').innerHTML=`<div class='status err'>æš‚æ— æ•°æ®/æŠ“å–å¤±è´¥ï¼š${esc(rel.error||'æœªçŸ¥')}</div>`;}
  else {
    const items=(rel.items||[]).filter(x=>matchKey(x,kw));
    $('relList').innerHTML=!items.length?'<div class="empty">æš‚æ— æ•°æ®</div>':`<table><thead><tr><th>æ—¥æœŸ</th><th>ä»£ç </th><th>åç§°</th><th>æ ‡é¢˜</th></tr></thead><tbody>${items.map(x=>`<tr><td>${esc(x.announcementTime)}</td><td>${esc(x.secCode)}</td><td>${esc(x.secName)}</td><td><a href='${esc(x.adjunctUrl||'#')}' target='_blank' rel='noopener noreferrer'>${esc(x.announcementTitle||'')}</a></td></tr>`).join('')}</tbody></table>`;
  }

  if(!p5w.ok){$('p5wList').innerHTML=`<div class='status err'>æš‚æ— æ•°æ®/æŠ“å–å¤±è´¥ï¼š${esc(p5w.error||'æœªçŸ¥')}</div>`;}
  else {
    const items=(p5w.items||[]).filter(x=>matchKey(x,kw));
    $('p5wList').innerHTML=!items.length?'<div class="empty">æš‚æ— æ•°æ®</div>':`<table><thead><tr><th>å›å¤æ—¶é—´</th><th>ä»£ç </th><th>åç§°</th><th>é—®é¢˜</th><th>å›å¤</th></tr></thead><tbody>${items.map(x=>`<tr><td>${esc(x.replyerTimeStr||x.questionerTimeStr||'')}</td><td>${esc(x.companyCode||'')}</td><td>${esc(x.companyShortname||'')}</td><td>${esc((x.content||'').slice(0,120))}</td><td>${esc((x.replyContent||'').slice(0,120))}</td></tr>`).join('')}</tbody></table>`;
  }

  if(!fc.ok){$('fcList').innerHTML=`<div class='status err'>æš‚æ— æ•°æ®/æŠ“å–å¤±è´¥ï¼š${esc(fc.error||'æœªçŸ¥')}</div>`;}
  else {
    const items=(fc.items||[]).filter(x=>matchKey({secCode:x.symbol,secName:x.company},kw));
    $('fcList').innerHTML=!items.length?'<div class="empty">æš‚æ— æ•°æ®</div>':`<table><thead><tr><th>å…¬å‘Šæ—¥</th><th>ä»£ç </th><th>åç§°</th><th>ç±»å‹</th><th>å˜åŠ¨å¹…åº¦%</th><th>æ‘˜è¦</th></tr></thead><tbody>${items.map(x=>`<tr><td>${esc(x.ann_date||'')}</td><td>${esc(x.symbol||'')}</td><td>${esc(x.company||'')}</td><td>${esc(x.type||'')}</td><td>${esc((x.p_change_min??'-'))} ~ ${esc((x.p_change_max??'-'))}</td><td>${esc((x.summary||x.change_reason||'').slice(0,160))}</td></tr>`).join('')}</tbody></table>`;
  }
}

async function loadByDate(date){
  if(!date){ setStatus('è¯·é€‰æ‹©æ—¥æœŸ','err'); return; }
  try{
    const r=await fetch(`./${date}.json?t=${Date.now()}`);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    currentData=await r.json();
    setStatus(`å·²åŠ è½½ ${date}.json`,'ok');
    render();
  }catch(e){
    currentData=null;
    setStatus(`åŠ è½½å¤±è´¥ï¼š${e.message}ã€‚å¯æ”¹é€‰å·²æœ‰æ—¥æœŸæˆ–æ‰‹åŠ¨å¯¼å…¥ JSONã€‚`,'err');
    $('annStats').innerHTML=''; $('annList').innerHTML=''; $('relList').innerHTML=''; $('p5wList').innerHTML=''; $('fcList').innerHTML='';
    setKpi('kAnn','-'); setKpi('kRel','-'); setKpi('kP5w','-'); setKpi('kFc','-');
  }
}

async function initDates(){
  try{
    const r=await fetch('./dates.json?t='+Date.now());
    if(!r.ok) throw new Error('no manifest');
    const j=await r.json();
    availableDates=(j.dates||[]);
  }catch(_){availableDates=[];}
  if(availableDates.length){
    $('dateInput').value=availableDates[0];
    setStatus(`å·²å‘ç° ${availableDates.length} ä¸ªå¯ç”¨æ—¥æœŸï¼Œé»˜è®¤åŠ è½½æœ€æ–° ${availableDates[0]}`);
    await loadByDate(availableDates[0]);
    return;
  }
  const t=new Date();
  const y=t.getFullYear(),m=String(t.getMonth()+1).padStart(2,'0'),d=String(t.getDate()).padStart(2,'0');
  const today=`${y}-${m}-${d}`;
  $('dateInput').value=today;
  setStatus('æœªå‘ç°æ—¥æœŸæ¸…å•ï¼Œå°è¯•åŠ è½½ä»Šæ—¥æ•°æ®â€¦');
  await loadByDate(today);
}

$('loadBtn').addEventListener('click',()=>loadByDate($('dateInput').value));
$('keywordInput').addEventListener('input',render);
$('fileInput').addEventListener('change',async e=>{const f=e.target.files?.[0]; if(!f) return; try{currentData=JSON.parse(await f.text()); setStatus(`å·²åŠ è½½æ–‡ä»¶ï¼š${f.name}`,'ok'); render();}catch(err){setStatus(`æ–‡ä»¶è§£æå¤±è´¥ï¼š${err.message}`,'err');}});
initDates();
</script>
</body>
</html>